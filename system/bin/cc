#!/system/bin/sh
#CONSTANTS
level_stp=60
level_res=40
#PATHS
path_plug="/sys/class/power_supply/sm7250_bms/online"
path_batt="/sys/class/power_supply/battery/capacity"
path_stop="/sys/class/power_supply/sm7250_bms/charge_disable"
path_amps="/sys/class/power_supply/sm7250_bms/constant_charge_current_max"
#FUNCTIONS
nfc() {
  if [ $(dumpsys nfc | grep "mState=") == "mState=off" ]; then
    echo 0
  else
    echo 1
  fi
}

plug() {
  cat $path_plug
}

batt() {
  cat $path_batt
}

plug_wait() {
  if [ $(nfc) == 1 ]; then
    echo "NFC"
    echo 3900000 > $path_amps
    echo 0 > $path_stop
    "cmd notification post -S bigtext -t 'Pixel5-CC' 'System' 'Phone will charge normally until NFC is disabled.'"
    return
  fi
  if [ $(plug) == 0 ]; then
    return
  fi
  sleep 5
}

charge() {
  local stop=$1

  echo $stop > $path_stop
  if [[ $stop == 1 ]]; then
    echo "Stop"
    while [[ $(batt) -gt $level_res ]]; do
      plug_wait
    done
    return
  fi

  echo "charge"
  echo 500000 > $path_amps
  while [[ $(batt) -lt $level_stp ]]; do
    plug_wait
  done
}
#MAIN
while true; do
  if [ $(plug) == 1 ] && [ $(nfc) == 0 ]; then
    if [[ $(batt) -lt $level_res ]]; then
      charge 0
    else
      charge 1
    fi
  fi
  sleep 5
done